<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <meta name="description" content="Cross-runtime .NET disassembly with BenchmarkDotNet">
    <meta name="author" content="Andrey Akinshin">
    <link href="/img/favicon.ico" rel="icon" type="image/x-icon"/>
    <meta name="keywords" content='.NET,C#,BenchmarkDotNet,benchmarking,disassembly'>

    <title>Cross-runtime .NET disassembly with BenchmarkDotNet</title>

    <!-- Bootstrap CSS -->
    <link href="/css/lumen-bootstrap.min.css" rel="stylesheet" type="text/css" media="all">
    <link href="/css/minty-bootstrap.min.css" rel="stylesheet" type="text/css" media="all" disabled>
    <link href="/css/sketchy-bootstrap.min.css" rel="stylesheet" type="text/css" media="all" disabled>
    <link href="/css/slate-bootstrap.min.css" rel="stylesheet" type="text/css" media="all" disabled>
    <link href="/css/solar-bootstrap.min.css" rel="stylesheet" type="text/css" media="all" disabled>
    <link href="/css/superhero-bootstrap.min.css" rel="stylesheet" type="text/css" media="all" disabled>

    <!-- Highlight.js -->
    <link href="/css/github-highlight.css" rel="stylesheet" type="text/css" media="all">
    <link href="/css/hopscotch-highlight.css" rel="stylesheet" type="text/css" media="all" disabled>
    <link href="/css/solarized-highlight.css" rel="stylesheet" type="text/css" media="all" disabled>
    <link href="/css/darcula-highlight.css" rel="stylesheet" type="text/css" media="all" disabled>

    <!-- FontAwesome -->
    <link href="/css/fontawesome-all.min.css" rel="stylesheet" type="text/css" media="all">
    
    <!-- Custom styles -->
    <link href="/css/about.css" rel="stylesheet" type="text/css" media="all">
    <link href="/css/blog.css" rel="stylesheet" type="text/css" media="all">

    <!-- Load theme -->
    <script src="/js/load-theme.js"></script>

    <!-- Feeds -->
    <link href="/en/rss.xml" type="application/rss+xml" rel="alternate" title="Blog RSS Feed" />
    <link href="/en/atom.xml" type="application/atom+xml" rel="alternate" title="Blog ATOM Feed" />

    <!-- Google analytics -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-41419012-5', 'auto');
      ga('send', 'pageview');
    </script>
    <!-- Yandex.Metrika counter -->
    <script type="text/javascript" >
        (function (d, w, c) {
            (w[c] = w[c] || []).push(function() {
                try {
                    w.yaCounter28700916 = new Ya.Metrika({
                        id:28700916,
                        clickmap:true,
                        trackLinks:true,
                        accurateTrackBounce:true,
                        webvisor:true,
                        trackHash:true
                    });
                } catch(e) { }
            });

            var n = d.getElementsByTagName("script")[0],
                s = d.createElement("script"),
                f = function () { n.parentNode.insertBefore(s, n); };
            s.type = "text/javascript";
            s.async = true;
            s.src = "https://mc.yandex.ru/metrika/watch.js";

            if (w.opera == "[object Opera]") {
                d.addEventListener("DOMContentLoaded", f, false);
            } else { f(); }
        })(document, window, "yandex_metrika_callbacks");
    </script>
    <noscript><div><img src="https://mc.yandex.ru/watch/28700916" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
    <!-- /Yandex.Metrika counter -->

    <!-- jQuery -->
    <script src="/js/jquery-3.2.1.slim.min.js"></script>
  </head>

  <body>
    <div class="bg-primary">
      <div class="container bg-primary">
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
          <ul class="navbar-nav mr-auto">
            <li class="nav-item">
              <a class="nav-link" id="nav-link-blog" href="/blog/">Blog</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" id="nav-link-blog-content" href="/blog/content/">Content</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" id="nav-link-about" href="/about/">About author</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href='/ru/blog/post/dotnet-crossruntime-disasm/'>Russian version</a>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false">Theme</a>
              <div class="dropdown-menu">
                  <h6 class="dropdown-header" style="text-align: center">Light</h6>
                  <a class="dropdown-item" href="#" onclick="setTheme('lumen', 'github');">lumen</a>
                  <a class="dropdown-item" href="#" onclick="setTheme('sketchy', 'github');">sketchy</a>
                  <a class="dropdown-item" href="#" onclick="setTheme('minty', 'github');">minty</a>
                  <div class="dropdown-divider"></div>
                  <h6 class="dropdown-header" style="text-align: center">Dark</h6>
                  <a class="dropdown-item" href="#" onclick="setTheme('solar', 'solarized');">solar</a>
                  <a class="dropdown-item" href="#" onclick="setTheme('slate', 'darcula');">slate</a>
                  <a class="dropdown-item" href="#" onclick="setTheme('superhero', 'hopscotch');">superhero</a>
              </div>
            </li>
          </ul>
        </nav>
      </div>
    </div>

    <div class="container">
      <div class="blog-main">
<div class="blog-post">

<h2 class="blog-post-title" id="post-title">Cross-runtime .NET disassembly with BenchmarkDotNet</h2>
<span class="blog-post-meta">
  <b>Date:</b> April 10, 2018.
  <b>Tags:</b>
        <a href="/blog/tag/dotnet"><span class="badge badge-pill badge-info">.NET</span></a>
        <a href="/blog/tag/csharp"><span class="badge badge-pill badge-info">C#</span></a>
        <a href="/blog/tag/benchmarkdotnet"><span class="badge badge-pill badge-info">BenchmarkDotNet</span></a>
        <a href="/blog/tag/benchmarking"><span class="badge badge-pill badge-info">benchmarking</span></a>
        <a href="/blog/tag/disassembly"><span class="badge badge-pill badge-info">disassembly</span></a>
</span><br /><br />

<p><a href="https://github.com/dotnet/BenchmarkDotNet">BenchmarkDotNet</a> is a cool tool for benchmarking.
It has a lot of useful features that help you with performance investigations.
However, you can use these features even if you are not actually going to benchmark something.
One of these features is <code>DisassemblyDiagnoser</code>.
It shows you a disassembly listing of your code for all required runtimes.
In this post, I will show you how to get disassembly listing for .NET Framework, .NET Core, and Mono with one click!
You can do it with a very small code snippet like this:</p>
<pre><code class="language-cs">[DryCoreJob, DryMonoJob, DryClrJob(Platform.X86)]
[DisassemblyDiagnoser]
public class IntroDisasm
{
    [Benchmark]
    public double Sum()
    {
        double res = 0;
        for (int i = 0; i &lt; 64; i++)
            res += i;
        return res;
    }
}
</code></pre>
<!--more-->
<p>That's all!
<code>[CoreJob]</code>, <code>[MonoJob]</code>, <code>[ClrJob]</code> mean that we are going to run it on .NET Core, Mono, and .NET Framework.
<code>[Dry]</code> means that we are going to run only single &quot;dry&quot; iteration for each runtime without actual measurements.
<code>[DisassemblyDiagnoser]</code> means that we want to get assembly listings in the <code>BenchmarkDotNet.Artifacts</code> folder.</p>
<p>Some important remarks:</p>
<ul>
<li>This benchmark requires .NET Framework, so it works only on Windows.</li>
<li>We use <code>Platform.X86</code> for <code>[ClrJob]</code> because we want to see a difference in assembly listing.
The modern versions of .NET Framework and .NET Core use the same JIT engine on <code>x64</code>.
So let's compare <code>LegacyJIT-x86</code> from .NET Framework and <code>RyuJIT-x64</code> from .NET Core.</li>
<li>To get assembly listings for Mono on Windows, you need <code>as</code> and <code>x86_64-w64-mingw32-objdump.exe</code> tools.
You can read more about it in the <a href="http://benchmarkdotnet.org/Configs/Diagnosers.htm#disassembly-diagnoser-for-mono-on-windows">documentation</a>.</li>
</ul>
<p>The source code (the benchmark + the csproj file) is available here: <a href="https://gist.github.com/AndreyAkinshin/62d2f4c3e67acde844f569fbf5846570">https://gist.github.com/AndreyAkinshin/62d2f4c3e67acde844f569fbf5846570</a>
You can try it on your machine with the help of the following script:</p>
<pre><code class="language-bash">git clone https://gist.github.com/62d2f4c3e67acde844f569fbf5846570.git DisasmDemo
cd DisasmDemo
dotnet run -f netcoreapp2.0 -c Release
start BenchmarkDotNet.Artifacts\results\IntroDisasm-disassembly-report.html
</code></pre>
<p>As a result, you will see an html page which contains disassembly listings for all runtimes:</p>
<div class="mx-auto"><a href="/img/posts/dotnet-crossruntime-disasm/disasm.png" target="_blank"><img class="mx-auto d-block" width="600" src="/img/posts/dotnet-crossruntime-disasm/disasm.png" /></a></div>
<p>The raw code:</p>
<pre><code class="language-x86asm">; .NET Framework 4.7 (CLR 4.0.30319.42000), 32bit LegacyJIT-v4.7.2633.0

07404098 DisasmDemo.IntroDisasm.Sum()
0740409c d9ee            fldz
0740409e 33c0            xor     eax,eax
074040a0 8945fc          mov     dword ptr [ebp-4],eax
074040a3 db45fc          fild    dword ptr [ebp-4]
074040a6 dec1            faddp   st(1),st
074040a8 40              inc     eax
074040a9 83f840          cmp     eax,40h
074040ac 7cf2            jl      074040a0
074040ae 8be5            mov     esp,ebp
</code></pre>
<pre><code class="language-x86asm">; .NET Core 2.0.6 (CoreCLR 4.6.26212.01, CoreFX 4.6.26212.01), 64bit RyuJIT

00007fff 196433b0 DisasmDemo.IntroDisasm.Sum()
00007fff 196433b3 c4e17957c0      vxorpd  xmm0,xmm0,xmm0
00007fff 196433b8 33c0            xor     eax,eax
00007fff 196433ba c4e17057c9      vxorps  xmm1,xmm1,xmm1
00007fff 196433bf c4e1732ac8      vcvtsi2sd xmm1,xmm1,eax
00007fff 196433c4 c4e17b58c1      vaddsd  xmm0,xmm0,xmm1
00007fff 196433c9 ffc0            inc     eax
00007fff 196433cb 83f840          cmp     eax,40h
00007fff 196433ce 7cea            jl      00007fff 196433ba
00007fff 196433d0 c3              ret
</code></pre>
<pre><code class="language-x86asm">; Mono 5.4.0 (Visual Studio), 64bit

 Sum
sub    $0x18,%rsp
mov    %rsi,(%rsp)
xorpd  %xmm0,%xmm0
movsd  %xmm0,0x8(%rsp)
xor    %esi,%esi
jmp    2e 
xchg   %ax,%ax
movsd  0x8(%rsp),%xmm0
cvtsi2sd %esi,%xmm1
addsd  %xmm1,%xmm0
movsd  %xmm0,0x8(%rsp)
inc    %esi
cmp    $0x40,%esi
jl     18 
movsd  0x8(%rsp),%xmm0
mov    (%rsp),%rsi
add    $0x18,%rsp
retq
</code></pre>
<p>As you can see, BenchmarkDotNet uses different diasasm style for each runtime.
Well, <code>DisassemblyDiagnoser</code> is a recent feature, it works, but we did not have enough time to polish it.
However, BenchmarkDotNet is <a href="https://github.com/dotnet/BenchmarkDotNet/wiki/ChangeLog">rapidly evolving</a>,
each version contains many improvements and bug fixes.
If you want to help with the disasm support, <a href="https://github.com/dotnet/BenchmarkDotNet#contributions-are-welcome">contributions are welcome</a>!</p>

<!-- Share -->

Share:
<a href="https://twitter.com/intent/tweet?text=Cross-runtime .NET disassembly with BenchmarkDotNet&url=http://aakinshin.net/blog/post/dotnet-crossruntime-disasm/&via=andrey_akinshin&related=andrey_akinshin" rel="nofollow" target="_blank" title="Share on Twitter"><i class="fab fa-twitter fa-2x" title="Twitter"></i></a>
<a href="https://www.reddit.com/submit?url=http://aakinshin.net/blog/post/dotnet-crossruntime-disasm/" target="_blank" title="Share on Reddit"><i class="fab fa-reddit fa-2x"></i></a>
<a href="https://news.ycombinator.com/submitlink?u=http://aakinshin.net/blog/post/dotnet-crossruntime-disasm/" target="_blank" title="Share on HackerNews"><i class="fab fa-hacker-news fa-2x"></i></a>
<a href="https://facebook.com/sharer.php?u=http://aakinshin.net/blog/post/dotnet-crossruntime-disasm/" rel="nofollow" target="_blank" title="Share on Facebook"><i class="fab fa-facebook fa-2x"></i></a>
<a href="https://plus.google.com/share?url=http://aakinshin.net/blog/post/dotnet-crossruntime-disasm/" rel="nofollow" target="_blank" title="Share on Google+"><i class="fab fab fa-google-plus-g fa-2x"></i></a>
<a href="http://vk.com/share.php?url=http://aakinshin.net/blog/post/dotnet-crossruntime-disasm/" target="_blank" title="Share on VKontakte"><i class="fab fa-vk fa-2x"></i></a>
<a href="https://getpocket.com/save?url=http://aakinshin.net/blog/post/dotnet-crossruntime-disasm/&title=Cross-runtime .NET disassembly with BenchmarkDotNet" target="_blank" title="Add to Pocket"><i class="fab fa-get-pocket fa-2x"></i></a>
<hr />

<!-- GitHub -->
<div>
  You can find source code of this post on GitHub:<br />
  <a href="https://github.com/AndreyAkinshin/aakinshin.net/blob/master/web/_posts/en/2018/dotnet-crossruntime-disasm.md">https://github.com/AndreyAkinshin/aakinshin.net/blob/master/web/_posts/en/2018/dotnet-crossruntime-disasm.md</a>
</div>

</div>
</div>
    </div>

    <footer class="blog-footer bg-light">
      <div class="container">
        <p>&copy; 2013â€“2018 Andrey Akinshin</p>
      </div>
    </footer>

    <!-- jQuery first (header), then popper, then Bootstrap JS. -->
    <script src="/js/popper.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <!-- Other scripts -->
    <script src="/js/highlight.pack.js"></script>
    <script src="/js/anchor.min.js"></script>
    <script src="/js/custom.js"></script>
  </body>
</html>
